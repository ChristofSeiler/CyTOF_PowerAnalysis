---
title: "Power Analysis for Elena's K Proposal"
output: html_document
author: Christof Seiler
date: August, 2017
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Packages

Install packages.

```{r warning=FALSE, message=FALSE}
pkgs_needed = c("ggplot2","reshape2","tibble","dplyr","magrittr","stringr","devtools","readr","assertthat",
                "parallel","flowCore","MASS","cowplot","truncnorm","truncdist")
letsinstall = setdiff(pkgs_needed, installed.packages()) 
if (length(letsinstall) > 0) {
  source("http://bioconductor.org/biocLite.R")
  biocLite(letsinstall)
}
```

Load packages.

```{r load_packages}
library("CytoGLMM")
library("ggplot2")
library("reshape2")
library("tibble")
library("dplyr")
library("magrittr")
library("stringr")
library("readr")
library("devtools")
library("assertthat")
library("parallel")
library("flowCore")
library("MASS")
library("cowplot")
library("truncnorm")
library("truncdist")
theme_set(theme_gray())
```

## Simulation Parameters

* Total number of makers: 36
* Differential markers: 5 to 10
* Number of NK cells: 5,000 to 10,000
* Fold change: 1.5 (e.g. the mean intensity count is 100 in condition A and 150 in condition B/A=1.5)
* Sample sizes:
    * Study 1: 3 groups (n1=18,n2=61,n3=24)
    * Study 2: 2 groups (n1=24,n1=24)
    * Study 3: 2 groups (n1=25,n2=25)

## Data from Previous Study

Marker information.

```{r read_csv}
markers_file_name = "markers.csv"
markers = read_csv(markers_file_name,col_types = cols(isotope = col_character(),
                                                      protein_name = col_character(),
                                                      type = col_factor(c("extracellular","intracellular"))))
```

Transform with `asinh` with standard scale parameter `b = 5`.

```{r load_sample}
b = 5
fcsB = read.FCS("D309T_NK_00_normalized_NK RAINBOW_12-Dec-2016.fcs",transformation = FALSE)
exprs_raw = as.tibble(fcsB@exprs[,markers$isotope])
exprs = as_tibble(asinh(fcsB@exprs[,markers$isotope]/b))
```

Change marker name from isotope name to protein name and remove markers that are unmapped.

```{r map_protein_names}
new_col_names = markers$protein_name
names(new_col_names) = markers$isotope
exprs = plyr::rename(exprs, new_col_names)
exprs_raw = plyr::rename(exprs_raw, new_col_names)
str(exprs)
str(exprs_raw)
```

Plot raw expressions.

```{r plot_markers_raw, fig.width=10, fig.height=7}
exprs_raw_long = melt(exprs_raw)
exprs_raw_long %<>% dplyr::filter(value < 100)
ggplot(exprs_raw_long,aes(x = value,y = ..scaled..)) +
      geom_density() +
      facet_wrap(~ variable,ncol = 8) +
      xlab("raw counts")
```

Plot transformed expressions.

```{r plot_markers_transformed, fig.width=10, fig.height=7}
exprs_long = melt(exprs)
ggplot(exprs_long,aes(x = value,y = ..scaled..)) +
      geom_density() +
      facet_wrap(~ variable,ncol = 8) +
      xlab("arcsinh transformed counts")
```

Plot transformed expressions without zeros.

```{r plot_markers_no_zeros, fig.width=10, fig.height=7}
exprs_long = melt(exprs)
exprs_long %<>% dplyr::filter(value > 0)
ggplot(exprs_long,aes(x = value)) +
  geom_histogram() +
  facet_wrap(~ variable,ncol = 8) +
  xlab("arcsinh transformed counts")
```

Fit a normal to non-zero transformed counts.

```{r normal_fit, fig.width=10, fig.height=7}
normal_fit_plots = lapply(names(exprs),function(marker_name) {
  xmin = min(exprs)
  xmax = max(exprs)
  exprs_selection = exprs[,marker_name] %>% dplyr::filter(. > xmin)
  fit = fitdistr(x = pull(exprs_selection,marker_name),densfun = "normal")
  ggplot(exprs_selection,aes_string(marker_name)) + 
    geom_histogram(aes(y = ..density..),bins = 50) + 
    stat_function(fun = dnorm, colour = "red",
                  args = list(mean = fit$estimate[1], 
                             sd = fit$estimate[2]),
                  size = 1) +
    xlim(xmin,xmax) +
    theme(axis.title.y = element_blank())
})
plot_grid(plotlist = normal_fit_plots,ncol = 8)
```

Fit a normal to non-zero transformed counts.

```{r exp_fit, fig.width=10, fig.height=7}
exp_fit_plots = lapply(names(exprs),function(marker_name) {
  xmin = min(exprs)
  xmax = max(exprs)
  exprs_selection = exprs[,marker_name] %>% dplyr::filter(. > xmin)
  fit = fitdistr(x = pull(exprs_selection,marker_name),densfun = "exponential")
  ggplot(exprs_selection,aes_string(marker_name)) + 
    geom_histogram(aes(y = ..density..),bins = 50) + 
    stat_function(fun = dexp, colour = "red",
                  args = list(rate = fit$estimate[1]),
                  size = 1) +
    xlim(xmin,xmax) +
    theme(axis.title.y = element_blank())
})
plot_grid(plotlist = exp_fit_plots,ncol = 8)
```

## Model Fit

Classify markers into two types: 

* `inactive`: modeled with a exponential distribuion
* `active`: modeled with a normal distribution

In both cases we inflate the distribution with zeros according to the observed frequency from the example sample.

```{r model_fit}
marker_normal = c("CD38","CD2","NKG2D","TIGIT","X_2B4",
                  "DNAM_1","FAS_L","CD94","NTB_A","CD56","CD16")
marker_exp = c("CD57","HLA_DR","CD69","LILRB1","CD8","CD62L",
               "KIR2DS4","KIR2DS2","NKp46","NKp30","Siglec_7",
               "NKG2C","NKp44","TACTILE","KIR2DL1","CXCR6",
               "PD1","KIR2DL5","NKG2A","KIR3DL1","KIR2DL3",
               "FcRg","Syk","Ki_67","Perforin")
# sanity checks
assert_that( unique(c(marker_normal,marker_exp)) %>% length == length(names(exprs)) )
assert_that( intersect(marker_normal,marker_exp) %>% length == 0 )
# plot rearranged
fit_plots = c( normal_fit_plots[sapply(marker_normal,function(marker_name) which(names(exprs) == marker_name))],
          exp_fit_plots[sapply(marker_exp,function(marker_name) which(names(exprs) == marker_name))] )
plot_grid(plotlist = fit_plots,ncol = 8)
# recompute and save estimated parameters and add zero proportions
normal_fit = lapply(marker_normal,function(marker_name) {
  exprs_selection = exprs[,marker_name] %>% dplyr::filter(. > min(exprs))
  fit = fitdistr(x = pull(exprs_selection,marker_name),densfun = "normal")
  fit$zero = mean(exprs[,marker_name]==0)
  fit$marker_name = marker_name
  fit
})
exp_fit = lapply(marker_exp,function(marker_name) {
  exprs_selection = exprs[,marker_name] %>% dplyr::filter(. > min(exprs))
  fit = fitdistr(x = pull(exprs_selection,marker_name),densfun = "exponential")
  fit$zero = mean(exprs[,marker_name]==0)
  fit$marker_name = marker_name
  fit
})
```

## Simulations

Make fake data.

```{r make_data}
make_data = function(n_cells = 10000,
                     fold_change = 1.5,
                     coeff_var = 0.1,
                     shifted_markers = "") {
  lapply(c(normal_fit,exp_fit),function(fit) {
    nonzero = rbinom(n = n_cells,size = 1,prob = 1-fit$zero)
    marker = rep(0,n_cells)
    if(fit$marker_name %in% marker_normal) {
      mean_estimate = fit$estimate["mean"]
      stdev = coeff_var*mean_estimate
      if(fit$marker_name %in% shifted_markers) {
        mean_estimate = rnorm(1,fold_change*mean_estimate,stdev)
      } else {
        mean_estimate = rnorm(1,mean_estimate,stdev)
      }
      marker[which(nonzero==1)] = rtruncnorm(n = sum(nonzero), 
                                             a = min(exprs), 
                                             b = max(exprs), 
                                             mean = mean_estimate,
                                             sd = fit$estimate["sd"])
    } else {
      rate_empirical = sapply(exp_fit,function(fit) fit$estimate["rate"])
      rate_estimate = runif(n = 1,min = min(rate_empirical),max = max(rate_empirical))
      marker[which(nonzero==1)] = rtrunc(n = sum(nonzero),
                                         spec = "exp",
                                         a = min(exprs), 
                                         b = max(exprs),
                                         rate = rate_estimate)
    }
    tb = tibble(marker)
    names(tb) = fit$marker_name
    tb
  }) %>% bind_cols
}
exprs_new = make_data(shifted_markers = c("CD38","CD2"))
exprs_new_long = melt(exprs_new)
ggplot(exprs_new_long,aes(x = value,y = ..scaled..)) +
  geom_density() +
  facet_wrap(~ variable,ncol = 8) +
  xlab("arcsinh transformed counts")
```

Simulate data for two group comparisons.

```{r simulate_groups}
simulate_two_groups = function(n_donors) {
  exprs_group1 = lapply(seq(n_donors),function(i) make_data() %>% 
                          add_column(donor = i)) %>% bind_rows
  exprs_group2 = lapply(seq(n_donors),function(i) make_data(shifted_markers = c("CD38")) %>% 
                          add_column(donor = i)) %>% bind_rows
  exprs_group1 %<>% add_column(treatment = "A")
  exprs_group2 %<>% add_column(treatment = "B")
  exprs_groups = bind_rows(exprs_group1,exprs_group2)
  exprs_groups$treatment %<>% factor
  exprs_groups$donor %<>% factor
  exprs_groups
}
exprs_groups = simulate_two_groups(n_donors = 10)
with(exprs_groups,table(donor,treatment))
exprs_groups_long = melt(exprs_groups,id.vars = c("donor","treatment"))
ggplot(exprs_groups_long,aes(x = value,y = ..scaled..,color = donor,linetype = treatment)) +
  geom_density() +
  facet_wrap(~ variable,ncol = 8) +
  xlab("arcsinh transformed counts")
```

Fit glmm.

```{r fit_glmm}
fit = glmm_ml(df_samples = exprs_groups,
              protein_names = names(exprs),
              response = "treatment",
              random_var = "donor",
              cores = 1)
plot(fit)
alpha = 0.01
pvalues(fit) %>% as.tibble %>% dplyr::filter(pvalues_adj < alpha)
```

## Session Info

```{r session_info}
session_info()
```
